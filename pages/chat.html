<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./style.css">
    <title>Messenger</title>
</head>
<body class="d-flex h-100 text-center text-white bg-dark">
    
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <h3 class="float-md-start mb-0">Messenger</h3>
        </div>
      </header>
      <br><br><br>
      <main class="px-3">
        <h3>Чат</h3>
        <form>
            <textarea name="nameUser" id="inputName" placeholder="Введите имя"></textarea>
            <button id="BtnUpdate" class="btn btn-danger">Изменить ник</button>
            <br>
            <textarea name="nameRoom" id="inputRoom" placeholder="Название комнаты"></textarea>
            <button id="BtnJoin" class="btn btn-danger">Подключиться</button>
            <br>
            <div id="dialog" class="border_style_double"></div>
            <p><select multiple name="name[]" class="select_style" id="selectName"></select><select multiple name="id[]" class="select_style" id="selectId"></select></p>
            <br>
            <textarea name="message" id="message" class="form-control" placeholder="Введите сообщение"></textarea>
            <br>
            <button id="BtnSend" class="btn btn-danger">Отправить</button>
        </form>
      </main><br><br><br>
    
      <footer class="mt-auto text-white-50">
        <p>Messenger by <a href="https://vk.com/dipush01" class="text-white">Иргалиев А</a>.</p>
      </footer>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>  
        $(function(){
            var socket = io.connect();  // при входе на страницу подключаемся к серверу (срабатывается событие connection)

            var $message = $("#message");                   // обращается к текстовому полю для ввода смс
            var $dialog = $("#dialog");                     // обращается к полю, куда будут выводиться все смс
            var $nameUser = $("#inputName");                 // обращаемся к полю ввода нового имени
            var $nameRoom = $("#inputRoom");                 // обращаемся к полю ввода комнаты
            var $nameSelect = $('#selectName');             // обращение к селектору для выбора онлайн-клиентов (имя)
            var $idSelect = $('#selectId');                 // обращение к селектору для выбора онлайн-клиентов (айди)

            // Вход в общий чат
            socket.on('join-room', "general");
            // Обновление ника
            document.getElementById("BtnUpdate").addEventListener("click", () => {UpdateNickname()});
            function UpdateNickname(){
                event.preventDefault(); // функция предотвращает стандартное поведение формы (обновление странички при нажатии)
                socket.emit('update-name-inroom', $nameUser.val());
            }
            // Сообщение пользователям, что клиент обновил ник
            socket.on('new-nick', function(data){
                $dialog.append("<div>Пользователь <b>" + data.user.name + " </b> поменял никнейм на <b>" + data.newName + "</b></div>");
            });
            // Подключиться к комнате (создать комнату)
            document.getElementById("BtnJoin").addEventListener("click", () => {JoinRoom()});
            function JoinRoom(){
                event.preventDefault(); // функция предотвращает стандартное поведение формы (обновление странички при нажатии)
                if($nameRoom.val())
                {
                    socket.emit('leave-room');
                    socket.emit('join-room', $nameRoom.val());
                }  
            }
            // Отправить сообщение
            document.getElementById("BtnSend").addEventListener("click", () => {SendMsg()});
            function SendMsg(){
                event.preventDefault(); // функция предотвращает стандартное поведение формы (обновление странички при нажатии)
                socket.emit('msg-room', {content: $message.val(), time: new Date().getHours() + ":" + new Date().getMinutes()+ ":" + new Date().getSeconds()});  // вызывает событие при нажатию на кнопку (отправка сообщение из текстового поля textarea)
                $message.val(''); // очищаем текстовое поле после отправки смс
            }
            // Вывести сообщение пользователям
            socket.on('add-msg', function(data){
                $dialog.append("<div>" + data.time + " <b>" + data.User.name + "</b>: " + data.content + "</div>");
            });
            // Получить всех пользователей, которые онлайн
            socket.emit('get-users');
            // Вывести список пользователей
            socket.on('set-users', function(data){
                for(let item of data.names){
                    $nameSelect.append("<option value=\"" + item + "\">" +item + "</option>");
                }
                for(let item of data.id){
                    
                    $idSelect.append("<option value=\"" + item + "\">" +item + "</option>");
                }
            });
            // Отслеживать нажатие по списку пользователей
            document.getElementById('selectId').onchange=function () {getValue(this);}
            function getValue(Obj){
                $name.append(Obj.value);
            }

            
            
        });
    </script>
    </body>
</html>